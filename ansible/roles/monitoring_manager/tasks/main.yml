---
- name: Create configs
  community.docker.docker_config:
    name: "{{ item.name }}"
    data: "{{ lookup(item.type, item.file) }}"
    rolling_versions: true
    state: present
  no_log: true
  register: monitoring_docker_configs
  loop: "{{ monitoring_configs }}"

- name: Create docker secrets
  community.docker.docker_secret:
    name: metridoc_{{ item }}_v{{ metridoc_secrets_version }}
    data: '{{ lookup("vars", item) }}'
    state: present
  register: monitoring_docker_secrets
  loop:
    - grafana_admin_password
    - grafana_database_password
    - postgres_monitoring_password
  no_log: true

- name: Create docker secret for alertmanager config template
  community.docker.docker_secret:
    name: metridoc_alertmanager_config
    data: '{{ lookup("template", "alertmanager/alertmanager.yml.j2") }}'
    rolling_versions: true
    state: present
  register: metridoc_alertmanager_secret_config
  no_log: true

- name: Deploy monitoring
  community.docker.docker_stack:
    name: "metridoc"
    compose:
      - "{{ lookup('template', 'docker-compose.yml.j2') | from_yaml }}"
    state: present
  changed_when: false
  no_log: true
